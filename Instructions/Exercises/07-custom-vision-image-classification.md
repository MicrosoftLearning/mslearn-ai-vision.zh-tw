---
lab:
  title: 使用 Azure AI 自訂視覺分類影像
---

# 使用 Azure AI 自訂視覺分類影像

**Azure AI 自訂視覺**服務可讓您建立以自己的影像定型的電腦視覺模型。 您可用來定型*影像分類*和*物件偵測*模型；然後可從應用程式進行發佈和取用。

在此練習中，您將使用自訂視覺服務來定型可識別三種水果 (蘋果、香蕉和柳橙) 的影像分類模型。

## 複製本課程的存放庫

如果您尚未將 **mslearn-ai-vision** 程式碼存放庫複製到此實驗室運作所在的環境，請依照下列步驟執行這項操作。 否則，請在 Visual Studio Code 中開啟複製的資料夾。

1. 啟動 Visual Studio Code。
2. 開啟選擇區 (SHIFT+CTRL+P) 並執行 **Git：複製 ** 命令，將 `https://github.com/MicrosoftLearning/mslearn-ai-vision` 存放庫複製到本機資料夾 (哪個資料夾無關緊要)。
3. 複製存放庫後，請在 Visual Studio Code 中開啟此資料夾。
4. 等候其他檔案安裝以支援存放庫中的 C# 程式碼專案。

    > **注意**：如果系統提示您新增必要的資產來組建和偵錯，請選取 [現在不要]****。 如果出現提示訊息：「在資料夾中偵測到 Azure 函式專案」**，您可以放心關閉該訊息。

## 建立自訂視覺資源

在定型模型之前，您需要 Azure 資源進行*定型*和*預測*。 您可以為每項工作建立**自訂視覺**資源，也可以建立單一 **Azure AI 服務**資源並將其用於任一工作 (或兩者)。

在此練習中，您將建立**自訂視覺**資源進行定型和預測，以便分別管理這些工作負載的存取和成本。

1. 在新的瀏覽器索引標籤中，開啟 Azure 入口網站 (位於 `https://portal.azure.com`)，使用與您的 Azure 訂用帳戶相關聯的 Microsoft 帳戶進行登入。
2. 選取 [&65291;建立資源]**** 按鈕，搜尋*自訂視覺*，然後使用下列設定建立**自訂視覺**資源：
    - **建立選項**：兩者
    - **訂用帳戶**：您的 Azure 訂用帳戶**
    - **資源群組**：*選擇或建立資源群組 (如果您使用受限制的訂用帳戶，則您可能沒有建立新資源群組的權限 - 請使用所提供的資源群組)*
    - **區域**：*選擇任何可用的區域*
    - **名稱**：輸入唯一名稱**
    - **定型定價層**：F0
    - **預測定價層**：F0

    > **注意**：若您的訂用帳戶中已經有 F0 自訂視覺服務，請為這一個選取 [S0]****。

3. 等候資源建立，然後檢視部署詳細資料，並注意已佈建兩個自訂視覺資源；一個用於定型，另一個用於預測 (以 **-Prediction** 尾碼顯示)。 您可以透過導覽到建立它們的資源群組來檢視這些資源。

> **重要**：每個資源都有自己的*端點*和*金鑰*，可用來管理來自程式碼的存取。 若要定型影像分類模型，您的程式碼必須使用*定型*資源 (搭配其端點和金鑰)；而若要使用定型的模型來預測影像類別，您的程式碼必須使用*預測*資源 (搭配其端點和金鑰)。

## 建立自訂視覺專案

若要定型影像分類模型，您需要根據定型資源建立自訂視覺專案。 為此，您將使用自訂視覺入口網站。

1. 在 Visual Studio Code 中，於您複製存放庫的 **Labfiles/07-custom-vision-image-classification/training-images** 資料夾中檢視定型影像。 此資料夾包含蘋果、香蕉和柳橙影像的子資料夾。
2. 在新的瀏覽器索引標籤中，開啟自訂視覺入口網站 (位於 `https://customvision.ai`)。 如果出現提示，請使用與 Azure 訂用帳戶相關聯的 Microsoft 帳戶進行登入，並同意服務條款。
3. 在自訂視覺入口網站中，使用下列設定建立新的專案：
    - **名稱**：水果分類
    - **描述**：水果影像分類
    - **資源**：*您先前建立的自訂視覺資源*
    - **專案類型**：分類
    - **分類類型**：多類別 (每一影像一個標籤)
    - **領域**：食物
4. 在新的專案中，按一下 [\[+\] 新增影像]****，然後選取您先前檢視的 **Labfiles/07-custom-vision-image-classification/training-images/apple** 資料夾中的所有檔案。 然後上傳影像檔，並指定 *apple* 標籤，如下所示：

![上傳帶有蘋果標記的蘋果](../media/upload_apples.jpg)
   
5. 重複上一個步驟，以使用 *banana* 標籤上傳 **banana** 資料夾中的影像，以及使用 *orange* 標籤上傳 **orange** 資料夾中的影像。
6. 探索您在自訂視覺專案中上傳的影像 - 每個類別應該會有 15 個影像，如下所示：

![已標記的水果影像，15 個蘋果、15 個香蕉和 15 個柳橙](../media/fruit.jpg)
    
7. 在自訂視覺專案中，於影像上方按一下 [定型]**** 以使用已加上標籤的影像來定型分類模型。 選取 [快速定型]**** 選項，然後等候定型反覆項目完成 (這可能需要一分鐘左右的時間)。
8. 當模型反覆項目已完成定型時，請檢閱*精確度*、*重新叫用率*和 *AP* 效能計量 - 這些計量會測量分類模型的預測精確度，而且值應該都很高。

> **注意**：效能計量是以每個預測的機率閾值 50% 為基礎 (換句話說，如果模型計算影像屬於特定類別的機率為 50% 或更高，則會預測該類別)。 您可以在頁面左上方調整此值。

## 測試模型

既然您已定型模型，即可加以測試。

1. 在效能計量上方，按一下 [快速測試]****。
2. 在 [影像 URL]**** 方塊中，輸入 `https://aka.ms/apple-image`，然後按一下 &#10132;
3. 檢視模型傳回的預測 - *apple* 的可能性分數應該會最高，如下所示：

![具有蘋果類別預測的影像](../media/test-apple.jpg)

4. 關閉 [快速測試]**** 視窗。

## 檢視專案設定

您建立的專案已獲得唯一的識別碼，您必須在與其互動的任何程式碼中指定該識別碼。

1. 按一下 [效能]**** 頁面右上方的設定** (&#9881;) 圖示，以檢視專案設定。
2. 在左側的 [一般]**** 之下，記下可唯一識別此專案的 [專案識別碼]****。
3. 在右側的 [資源]**** 之下，注意已顯示金鑰和端點。 這些是*定型*資源的詳細資料 (您也可以在 Azure 入口網站中檢視資源以取得這項資訊)。

## 使用*定型* API

自訂視覺入口網站提供方便的使用者介面，可供您上傳和標記影像，以及定型模型。 不過，在某些情況下，您可能想要使用自訂視覺定型 API 將模型定型自動化。

> **注意**：在此練習中，您可以選擇從 **C#** 或 **Python** SDK 使用 API。 在下列步驟中，執行適合您慣用語言的動作。

1. 在 Visual Studio Code 的 [瀏覽器]**** 窗格中，瀏覽至 **07-custom-vision-image-classification** 資料夾，然後根據您的語言喜好設定展開 **C-Sharp** 或 **Python** 資料夾。
2. 以滑鼠右鍵按一下 **train-classifier** 資料夾，然後開啟整合式終端機。 然後針對您的語言喜好設定執行適當的命令，以安裝自訂視覺定型套件：

**C#**

```
dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training --version 2.0.0
```

**Python**

```
pip install azure-cognitiveservices-vision-customvision==3.1.0
```

3. 檢視 **train-classifier** 資料夾的內容，並注意其中包含組態設定的檔案：
    - **C#**：appsettings.json
    - **Python**：.env

    開啟組態檔並更新其中包含的組態值，以反映您自訂視覺「定型」** 資源的端點和金鑰，以及您先前建立之分類專案的專案識別碼。 儲存您的變更。
4. 請注意，**text-classifier** 資料夾包含用戶端應用程式的程式碼檔案：

    - **C#**：Program.cs
    - **Python**：train-classifier.py

    開啟程式碼檔案並檢閱其所包含的程式碼，並注意下列詳細資料：
    - 從您安裝的套件匯入命名空間
    - **Main** 函式會擷取組態設定，並使用金鑰和端點來建立已驗證的 **CustomVisionTrainingClient**，然後搭配專案識別碼使用以建立專案的 **Project** 參考。
    - **Upload_Images** 函式會擷取自訂視覺專案中定義的標記，然後將影像檔案從對應命名的資料夾上傳至專案，並指派適當的標記識別碼。
    - **Train_Model** 函式會為專案建立新的定型反覆運算，並等候定型完成。
5. 傳回 **train-classifier** 資料夾的整合式終端機，然後輸入下列命令來執行程式：

**C#**

```
dotnet run
```

**Python**

```
python train-classifier.py
```
    
6. 等候程式結束。 然後返回瀏覽器，並在自訂視覺入口網站中檢視專案的 [定型影像]**** 頁面 (視需要重新整理瀏覽器)。
7. 確認已將一些已標記的新影像新增至專案。 然後檢視 [效能]**** 頁面，並確認已建立新的反覆運算。

## 發佈影像分類模型

您現在已準備好發佈已定型的模型，以便從用戶端應用程式使用該模型。

1. 在自訂視覺入口網站的 [效能]**** 頁面上，按一下 [&#128504; 發佈]**** 以發佈具有下列設定的已定型模型：
    - **模型名稱**：fruit-classifier
    - **預測資源**：*您先前建立的**預測**資源，其結尾是 "-Prediction" (<u>不是</u>定型資源)*。
2. 在 [專案設定] **** 頁面的左上方，按一下*專案資源庫* (&#128065;) 圖示以返回自訂視覺入口網站首頁，現在您的專案已在其中列出。
3. 在自訂視覺入口網站首頁的右上方，按一下設定 ** (&#9881;) 圖示以檢視自訂視覺服務的設定。 然後，在 [資源]**** 之下，尋找以 "-Prediction" 結尾的*預測*資源 (<u>不是</u>定型資源) 來判斷其**金鑰**和**端點**值 (您也可在Azure 入口網站中檢視資源以取得這項資訊)。

## 從用戶端應用程式使用影像分類器

既然您已發佈影像分類模型，即可從用戶端應用程式使用。 同樣地，您可以選擇使用 **C#** 或 **Python**。

1. 在 Visual Studio Code 的 **07-custom-vision-image-classification** 資料夾中，於您慣用語言的子資料夾中 (**C-Sharp** 或 **Python**)，以滑鼠右鍵按一下 **test-classifier** 資料夾，然後開啟整合式終端。 然後輸入下列 SDK 特有命令來安裝自訂視覺預測套件：

**C#**

```
dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Prediction --version 2.0.0
```

**Python**

```
pip install azure-cognitiveservices-vision-customvision==3.1.0
```

> **注意**：Python SDK 套件同時包含定型和預測套件，而且可能已經安裝。

2. 展開 **test-classifier** 資料夾以檢視其中包含的檔案，這些檔案用於實作影像分類模型的測試用戶端應用程式。
3. 開啟用戶端應用程式的組態檔 (適用於 C# 的*appsettings.json* 或適用於 Python 的 *.env*)，並更新其中包含的組態值，以反映自訂視覺「預測」** 資源的端點和金鑰、分類專案的專案識別碼，以及已發佈模型的名稱 (應該是 *fruit-classifier*)。 儲存您的變更。
4. 開啟用戶端應用程式的程式碼檔案 (適用於 C# 的 *Program.cs*，適用於 Python 的 *test-classification.py*)，並檢閱其所包含的程式碼，並注意下列詳細資料：
    - 從您安裝的套件匯入命名空間
    - **Main** 函式會擷取組態設定，並使用金鑰和端點來建立已驗證的 **CustomVisionPredictionClient**。
    - 預測用戶端物件用於預測 **test-images** 資料夾中每個影像的類別，並為每個要求指定專案識別碼和模型名稱。 每個預測都包含每個可能類別的機率，且只會顯示機率大於 50% 的預測標記。
5. 傳回 **train-classifier** 資料夾的整合式終端機，然後輸入下列 SDK 特有命令來執行程式：

**C#**

```
dotnet run
```

**Python**

```
python test-classifier.py
```

6. 檢視每個預測的標籤 (標記) 和機率分數。 您可以在 **test-images** 資料夾中檢視影像，以確認模型已正確分類。

## 其他相關資訊

如需使用自訂視覺服務進行影像分類的詳細資訊，請參閱[自訂視覺文件](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/)。
